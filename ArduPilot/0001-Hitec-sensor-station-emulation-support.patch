From 8e3bd2adf45cc71a190f037bb8b58274d56bd3bb Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Janne=20M=C3=A4ntyharju?= <janne.mantyharju@iki.fi>
Date: Wed, 11 Jul 2012 17:25:01 +0300
Subject: [PATCH] Hitec sensor station emulation support

---
 ArduPlane/ArduPlane.pde |  12 +++--
 ArduPlane/hss.pde       | 128 ++++++++++++++++++++++++++++++++++++++++++++++++
 ArduPlane/system.pde    |   1 +
 3 files changed, 136 insertions(+), 5 deletions(-)
 create mode 100644 ArduPlane/hss.pde

diff --git a/ArduPlane/ArduPlane.pde b/ArduPlane/ArduPlane.pde
index de80fa8..e1a2732 100644
--- a/ArduPlane/ArduPlane.pde
+++ b/ArduPlane/ArduPlane.pde
@@ -86,7 +86,8 @@ FastSerialPort1(Serial1);       // GPS port
 // solder bridge set to enable UART2 instead of USB MUX
 FastSerialPort2(Serial3);
 #else
-FastSerialPort3(Serial3);        // Telemetry port for APM1
+ FastSerialPort2(Serial2);
+ FastSerialPort3(Serial3);       // Telemetry port for APM1
 #endif
 
 // this sets up the parameter table, and sets the default values. This
@@ -533,7 +534,7 @@ int32_t wp_distance;
 static int32_t wp_totalDistance;
 
 // event control state
-enum event_type { 
+enum event_type {
     EVENT_TYPE_RELAY=0,
     EVENT_TYPE_SERVO=1
 };
@@ -680,8 +681,9 @@ AP_Mount camera_mount2(&current_loc, g_gps, &ahrs, 1);
 ////////////////////////////////////////////////////////////////////////////////
 
 void setup() {
-    memcheck_init();
-    init_ardupilot();
+	memcheck_init();
+	init_ardupilot();
+	hss_setup();
 }
 
 void loop()
@@ -813,10 +815,10 @@ static void medium_loop()
     // This is the start of the medium (10 Hz) loop pieces
     // -----------------------------------------
     switch(medium_loopCounter) {
-
     // This case deals with the GPS
     //-------------------------------
     case 0:
+    	hss_update();
         medium_loopCounter++;
         update_GPS();
         calc_gndspeed_undershoot();
diff --git a/ArduPlane/hss.pde b/ArduPlane/hss.pde
new file mode 100644
index 0000000..30a2453
--- /dev/null
+++ b/ArduPlane/hss.pde
@@ -0,0 +1,128 @@
+/*
+ * Functions for sending telemetry data via SPI to Hitec sensor station emulator
+ *
+ * Code: Janne MÅ ntyharju
+ */
+
+#if CONFIG_APM_HARDWARE == APM_HARDWARE_APM1
+#define HSS_SS 60      // PF6, chip select
+#endif
+
+enum hss_states {
+	hss_start = 0,
+	hss_temp,
+	hss_voltage,
+	hss_amps,
+	hss_current_total,
+	hss_battery_remaining,
+	hss_alt,
+	hss_groundspeed,
+	hss_num_satellites,
+	hss_airspeed,
+	hss_throttle,
+    hss_longitude,
+    hss_latitude,
+	hss_end
+};
+
+typedef union {
+        long l;
+        float f;
+        int i;
+        unsigned int ui;
+        unsigned char uc;
+        byte buf[4];
+} UNI;
+
+static byte hss_state = 0;
+static UNI u;
+
+void hss_setup()
+{
+#if CONFIG_APM_HARDWARE == APM_HARDWARE_APM1
+	pinMode(HSS_SS, OUTPUT);
+#endif
+}
+
+inline static void hss_send_byte(char c)
+{
+#if CONFIG_APM_HARDWARE == APM_HARDWARE_APM2
+	Serial2.write(c);
+#else
+	SPI.transfer(c);
+#endif
+}
+
+void hss_send_data(byte start)
+{
+	byte i;
+
+#if CONFIG_APM_HARDWARE == APM_HARDWARE_APM1
+	digitalWrite(HSS_SS, LOW);
+#endif
+
+	if(start) {
+		hss_send_byte('*');
+		hss_send_byte('*');
+	} else {
+		for(i = 0; i < 4; i++) {
+			hss_send_byte(u.buf[i]);
+		}
+	}
+#if CONFIG_APM_HARDWARE == APM_HARDWARE_APM1
+	digitalWrite(HSS_SS, HIGH);
+#endif
+
+}
+
+void hss_update()
+{
+	switch (hss_state) {
+		case hss_start:
+			hss_send_data(true);
+			break;
+		case hss_temp:
+			u.i = barometer.get_temperature();
+			break;
+		case hss_voltage:
+			u.f = battery_voltage1;
+			break;
+		case hss_amps:
+			u.f = current_amps1;
+			break;
+		case hss_current_total:
+			u.f = current_total1;
+			break;
+		case hss_battery_remaining:
+			u.uc = (5.0 * (g.pack_capacity - current_total1) / g.pack_capacity);
+			break;
+		case hss_alt:
+			u.ui = current_loc.alt;
+			break;
+		case hss_groundspeed:
+			u.l = g_gps->ground_speed;
+			break;
+		case hss_num_satellites:
+			u.uc = g_gps->num_sats;
+			break;
+		case hss_airspeed:
+			u.i = airspeed.get_airspeed_cm();
+			break;
+		case hss_throttle:
+			u.ui = g.channel_throttle.servo_out;
+			break;
+		case hss_longitude:
+			u.l = g_gps->longitude;
+			break;
+		case hss_latitude:
+			u.l = g_gps->latitude;
+			break;
+	}
+
+	if (hss_state != hss_start)
+		hss_send_data(false);
+
+	hss_state++;
+	if (hss_state == hss_end)
+		hss_state = 0;
+}
diff --git a/ArduPlane/system.pde b/ArduPlane/system.pde
index ec4a473..6f2f101 100644
--- a/ArduPlane/system.pde
+++ b/ArduPlane/system.pde
@@ -87,6 +87,7 @@ static void init_ardupilot()
     //
     // standard gps running
     Serial1.begin(38400, 256, 16);
+    Serial2.begin(38400, 128, 16);
 
     Serial.printf_P(PSTR("\n\nInit " THISFIRMWARE
                          "\n\nFree RAM: %u\n"),
-- 
1.7.11.3

