From 82cdb4c89a126b6431f280895d46fab424189bda Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Janne=20M=C3=A4ntyharju?= <janne.mantyharju@iki.fi>
Date: Fri, 4 Jan 2013 09:13:04 -0500
Subject: [PATCH] ArduPlane - hss emulation

---
 ArduPlane/ArduPlane.pde |    2 +
 ArduPlane/hss.pde       |  128 +++++++++++++++++++++++++++++++++++++++++++++++
 ArduPlane/system.pde    |    3 ++
 3 files changed, 133 insertions(+)
 create mode 100644 ArduPlane/hss.pde

diff --git a/ArduPlane/ArduPlane.pde b/ArduPlane/ArduPlane.pde
index 33e82d6..e49abf6 100644
--- a/ArduPlane/ArduPlane.pde
+++ b/ArduPlane/ArduPlane.pde
@@ -682,6 +682,7 @@ void setup() {
     airspeed.init(pitot_analog_source);
     memcheck_init();
     init_ardupilot();
+    hss_setup();
 }
 
 void loop()
@@ -812,6 +813,7 @@ static void medium_loop()
     // This case deals with the GPS
     //-------------------------------
     case 0:
+    	hss_update();
         medium_loopCounter++;
         update_GPS();
         calc_gndspeed_undershoot();
diff --git a/ArduPlane/hss.pde b/ArduPlane/hss.pde
new file mode 100644
index 0000000..310a620
--- /dev/null
+++ b/ArduPlane/hss.pde
@@ -0,0 +1,128 @@
+/*
+ * Functions for sending telemetry data via SPI to Hitec sensor station emulator
+ *
+ * Code: Janne MÅ ntyharju
+ */
+
+#if CONFIG_APM_HARDWARE == APM_HARDWARE_APM1
+#define HSS_SS 60      // PF6, chip select
+#endif
+
+enum hss_states {
+	hss_start = 0,
+	hss_temp,
+	hss_voltage,
+	hss_amps,
+	hss_current_total,
+	hss_battery_remaining,
+	hss_alt,
+	hss_groundspeed,
+	hss_num_satellites,
+	hss_airspeed,
+	hss_throttle,
+    hss_longitude,
+    hss_latitude,
+	hss_end
+};
+
+typedef union {
+        long l;
+        float f;
+        int i;
+        unsigned int ui;
+        unsigned char uc;
+        uint8_t buf[4];
+} UNI;
+
+static uint8_t hss_state = 0;
+static UNI u;
+
+void hss_setup()
+{
+#if CONFIG_APM_HARDWARE == APM_HARDWARE_APM1
+	pinMode(HSS_SS, OUTPUT);
+#endif
+}
+
+inline static void hss_send_byte(char c)
+{
+#if CONFIG_APM_HARDWARE == APM_HARDWARE_APM2
+	hal.uartC->write(c);
+#else
+	SPI.transfer(c);
+#endif
+}
+
+void hss_send_data(uint8_t start)
+{
+	uint8_t i;
+
+#if CONFIG_APM_HARDWARE == APM_HARDWARE_APM1
+	digitalWrite(HSS_SS, LOW);
+#endif
+
+	if(start) {
+		hss_send_byte('*');
+		hss_send_byte('*');
+	} else {
+		for(i = 0; i < 4; i++) {
+			hss_send_byte(u.buf[i]);
+		}
+	}
+#if CONFIG_APM_HARDWARE == APM_HARDWARE_APM1
+	digitalWrite(HSS_SS, HIGH);
+#endif
+
+}
+
+void hss_update()
+{
+	switch (hss_state) {
+		case hss_start:
+			hss_send_data(true);
+			break;
+		case hss_temp:
+			u.i = barometer.get_temperature();
+			break;
+		case hss_voltage:
+			u.f = battery_voltage1;
+			break;
+		case hss_amps:
+			u.f = current_amps1;
+			break;
+		case hss_current_total:
+			u.f = current_total1;
+			break;
+		case hss_battery_remaining:
+			u.uc = (5.0 * (g.pack_capacity - current_total1) / g.pack_capacity);
+			break;
+		case hss_alt:
+			u.ui = current_loc.alt;
+			break;
+		case hss_groundspeed:
+			u.l = g_gps->ground_speed;
+			break;
+		case hss_num_satellites:
+			u.uc = g_gps->num_sats;
+			break;
+		case hss_airspeed:
+			u.i = airspeed.get_airspeed_cm();
+			break;
+		case hss_throttle:
+			u.ui = g.channel_throttle.servo_out;
+			break;
+		case hss_longitude:
+			u.l = g_gps->longitude;
+			break;
+		case hss_latitude:
+			u.l = g_gps->latitude;
+			break;
+	}
+
+	if (hss_state != hss_start)
+		hss_send_data(false);
+
+	hss_state++;
+	if (hss_state == hss_end)
+		hss_state = 0;
+}
diff --git a/ArduPlane/system.pde b/ArduPlane/system.pde
index fd0dff6..08fcd4f 100644
--- a/ArduPlane/system.pde
+++ b/ArduPlane/system.pde
@@ -100,6 +100,9 @@ static void init_ardupilot()
     // standard gps running
     hal.uartB->begin(38400, 256, 16);
 
+    // Initialize HSS communication
+    hal.uartC->begin(38400, 128, 16);
+
     cliSerial->printf_P(PSTR("\n\nInit " THISFIRMWARE
                          "\n\nFree RAM: %u\n"),
                     memcheck_available_memory());
-- 
1.7.9.5

