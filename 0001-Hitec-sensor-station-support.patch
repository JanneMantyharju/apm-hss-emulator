From 26750dd2dd7be674acb30b62c459d9a8e0771590 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Janne=20M=C3=A4ntyharju?= <janne.mantyharju@iki.fi>
Date: Wed, 9 May 2012 08:32:28 +0300
Subject: [PATCH] Hitec sensor station support

---
 ArduPlane/ArduPlane.pde |    6 ++-
 ArduPlane/hss.pde       |  127 +++++++++++++++++++++++++++++++++++++++++++++++
 ArduPlane/system.pde    |    1 +
 3 files changed, 132 insertions(+), 2 deletions(-)
 create mode 100644 ArduPlane/hss.pde

diff --git a/ArduPlane/ArduPlane.pde b/ArduPlane/ArduPlane.pde
index 0b0efbf..89989f3 100644
--- a/ArduPlane/ArduPlane.pde
+++ b/ArduPlane/ArduPlane.pde
@@ -71,6 +71,7 @@ version 2.1 of the License, or (at your option) any later version.
 //
 FastSerialPort0(Serial);        // FTDI/console
 FastSerialPort1(Serial1);       // GPS port
+FastSerialPort2(Serial2);
 FastSerialPort3(Serial3);       // Telemetry port
 
 ////////////////////////////////////////////////////////////////////////////////
@@ -629,8 +630,6 @@ static unsigned long 	dTnav;
 // % MCU cycles used
 static float 			load;
 
-
-
 ////////////////////////////////////////////////////////////////////////////////
 // Top-level logic
 ////////////////////////////////////////////////////////////////////////////////
@@ -638,6 +637,7 @@ static float 			load;
 void setup() {
 	memcheck_init();
 	init_ardupilot();
+	hss_setup();
 }
 
 void loop()
@@ -766,6 +766,8 @@ static void medium_loop()
 		// This case deals with the GPS
 		//-------------------------------
 		case 0:
+			hss_update();
+
 			medium_loopCounter++;
 			if(GPS_enabled){
                 update_GPS();
diff --git a/ArduPlane/hss.pde b/ArduPlane/hss.pde
new file mode 100644
index 0000000..b7de51d
--- /dev/null
+++ b/ArduPlane/hss.pde
@@ -0,0 +1,127 @@
+/*
+ * Functions for sending telemetry data via SPI to Hitec sensor station emulator
+ *
+ * Code: Janne MŠntyharju
+ */
+
+#if CONFIG_APM_HARDWARE == APM_HARDWARE_APM1
+#define HSS_SS 60      // PF6, chip select
+#endif
+
+enum hss_states {
+	hss_start = 0,
+	hss_temp,
+	hss_voltage,
+	hss_amps,
+	hss_current_total,
+	hss_battery_remaining,
+	hss_alt,
+	hss_groundspeed,
+	hss_num_satellites,
+	hss_airspeed,
+	hss_throttle,
+    hss_longitude,
+    hss_latitude,
+	hss_end
+};
+
+typedef union {
+        long l;
+        int i;
+        unsigned int ui;
+        unsigned char uc;
+        byte buf[4];
+} UNI;
+
+static byte hss_state = 0;
+static UNI u;
+
+void hss_setup()
+{
+#if CONFIG_APM_HARDWARE == APM_HARDWARE_APM1
+	pinMode(HSS_SS, OUTPUT);
+#endif
+}
+
+inline static void hss_send_byte(char c)
+{
+#if CONFIG_APM_HARDWARE == APM_HARDWARE_APM2
+	Serial2.write(c);
+#else
+	SPI.transfer(c);
+#endif
+}
+
+void hss_send_data(byte start)
+{
+	byte i;
+
+#if CONFIG_APM_HARDWARE == APM_HARDWARE_APM1
+	digitalWrite(HSS_SS, LOW);
+#endif
+
+	if(start) {
+		hss_send_byte('*');
+		hss_send_byte('*');
+	} else {
+		for(i = 0; i < 4; i++) {
+			hss_send_byte(u.buf[i]);
+		}
+	}
+#if CONFIG_APM_HARDWARE == APM_HARDWARE_APM1
+	digitalWrite(HSS_SS, HIGH);
+#endif
+
+}
+
+void hss_update()
+{
+	switch (hss_state) {
+		case hss_start:
+			hss_send_data(true);
+			break;
+		case hss_temp:
+			u.ui = barometer.get_temperature();
+			break;
+		case hss_voltage:
+			u.ui = battery_voltage1;
+			break;
+		case hss_amps:
+			u.ui = current_amps1;
+			break;
+		case hss_current_total:
+			u.ui = current_total1;
+			break;
+		case hss_battery_remaining:
+			u.uc = (5.0 * (g.pack_capacity - current_total1) / g.pack_capacity);
+			break;
+		case hss_alt:
+			u.ui = current_loc.alt;
+			break;
+		case hss_groundspeed:
+			u.l = g_gps->ground_speed;
+			break;
+		case hss_num_satellites:
+			u.uc = g_gps->num_sats;
+			break;
+		case hss_airspeed:
+			u.i = airspeed;
+			break;
+		case hss_throttle:
+			u.ui = g.channel_throttle.servo_out;
+			break;
+		case hss_longitude:
+			u.l = g_gps->longitude;
+			break;
+		case hss_latitude:
+			u.l = g_gps->latitude;
+			break;
+	}
+
+	if (hss_state != hss_start)
+		hss_send_data(false);
+
+	hss_state++;
+	if (hss_state == hss_end)
+		hss_state = 0;
+}
diff --git a/ArduPlane/system.pde b/ArduPlane/system.pde
index 3a856b8..4f6e527 100644
--- a/ArduPlane/system.pde
+++ b/ArduPlane/system.pde
@@ -87,6 +87,7 @@ static void init_ardupilot()
 	//
     // standard gps running
     Serial1.begin(38400, 128, 16);
+    Serial2.begin(38400, 128, 16);
 
 	Serial.printf_P(PSTR("\n\nInit " THISFIRMWARE
 						 "\n\nFree RAM: %u\n"),
-- 
1.7.9

